<% layout('layouts/boilerplate2') %>

<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-7">

        <!-- Back + User info -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <a href="/qa" class="btn btn-outline-secondary">‚Üê Back to Q&A</a>
          <span class="text-muted small">Logged in as <strong><%= user.username %></strong>
            <span class="badge ms-1" style="background:<%= user.role==='expert'?'#6f42c1':user.role==='admin'?'#dc3545':'#2a8a15' %>; color:white;"><%= user.role.toUpperCase() %></span>
          </span>
        </div>

        <!-- Question -->
        <div class="card shadow-sm mb-4 border-0" style="border-left: 4px solid #2a8a15 !important; border-radius:12px;">
          <div class="card-body">
            <h1 class="fw-bold text-success fs-3"><%= question.title %></h1>
            <p class="text-secondary"><%= question.description %></p>
            <% if (question.tags && question.tags.length > 0) { %>
              <div class="mb-2"><% question.tags.forEach(t => { %><span class="badge bg-info text-dark me-1"><%= t %></span><% }) %></div>
            <% } %>
            <hr>
            <small class="text-muted">Asked by: <strong><%= question.askedBy %></strong></small>
          </div>
        </div>

        <!-- Answers -->
        <div class="card shadow-sm border-0 mb-4" style="border-radius:12px;">
          <div class="card-body">
            <h3 class="fw-semibold text-primary mb-3"><i class="fa fa-comments me-2"></i>Answers (<%= question.answers.length %>)</h3>
            <% if (question.answers.length === 0) { %>
              <p class="text-muted fst-italic">No answers yet. Be the first!</p>
            <% } else { %>
              <% question.answers.forEach(a => { %>
                <div class="border rounded-3 p-3 mb-3 bg-light">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="fa fa-user-circle text-success"></i>
                    <span class="fw-bold text-success"><%= a.answeredBy %></span>
                    <% if (a.answeredBy === user.username) { %><span class="badge bg-primary small">You</span><% } %>
                  </div>
                  <p class="mb-0 text-dark"><%= a.content %></p>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>

        <!-- Answer Form with Voice -->
        <div class="card shadow-sm border-0" style="border-radius:12px;">
          <div class="card-body">
            <h4 class="fw-semibold text-success mb-3"><i class="fa fa-reply me-2"></i>Post Your Answer</h4>

            <!-- Voice Input -->
            <div class="p-3 rounded mb-3" style="background:#f0f7ee;">
              <div class="d-flex align-items-center gap-2 mb-2">
                <button class="btn btn-success rounded-circle" style="width:46px;height:46px;" id="micBtn" onclick="toggleVoice()">
                  <i class="fa fa-microphone" id="micIcon"></i>
                </button>
                <select class="form-select form-select-sm" id="langSelect" style="max-width:160px;">
                  <option value="en-IN">English</option>
                  <option value="hi-IN">Hindi</option>
                  <option value="te-IN">Telugu</option>
                  <option value="ta-IN">Tamil</option>
                  <option value="kn-IN">Kannada</option>
                  <option value="mr-IN">Marathi</option>
                </select>
                <span id="voiceStatus" class="text-muted small">Tap mic to dictate your answer</span>
              </div>
              <button class="btn btn-sm btn-outline-success" onclick="applyVoice()">‚Üí Apply to Answer</button>
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearVoice()">Clear</button>
              <textarea id="voiceText" class="form-control mt-2" rows="2" placeholder="Voice text appears here..." readonly></textarea>
            </div>

            <form action="/answers/<%= question._id %>" method="POST">
              <div class="mb-3">
                <label class="form-label fw-semibold">Answering as: <span class="text-success"><%= user.username %></span></label>
                <textarea id="answerContent" name="content" class="form-control" rows="4" placeholder="Type or dictate your answer..." required></textarea>
              </div>
              <button type="submit" class="btn btn-success w-100 fw-semibold py-2">Submit Answer</button>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</body>
<script>
let recognition = null, isRecording = false;
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert('Use Chrome/Edge.'); return; }
  if (isRecording) { recognition.stop(); return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = true; recognition.interimResults = true;
  recognition.lang = document.getElementById('langSelect').value;
  recognition.onstart = () => { isRecording=true; document.getElementById('micBtn').style.background='#dc3545'; document.getElementById('micIcon').className='fa fa-stop'; document.getElementById('voiceStatus').textContent='üî¥ Listening...'; };
  recognition.onresult = (e) => { let t=''; for(let i=0;i<e.results.length;i++) t+=e.results[i][0].transcript; document.getElementById('voiceText').value=t; };
  recognition.onerror = stopRec; recognition.onend = stopRec;
  recognition.start();
}
function stopRec() { isRecording=false; document.getElementById('micBtn').style.background=''; document.getElementById('micIcon').className='fa fa-microphone'; document.getElementById('voiceStatus').textContent='Done!'; }
function applyVoice() { document.getElementById('answerContent').value = document.getElementById('voiceText').value; }
function clearVoice() { document.getElementById('voiceText').value=''; }
</script>
